<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Group Extractor v6.0.7 - Side Panel</title>
    <link rel="stylesheet" href="sidepanel.css">
    <link rel="stylesheet" href="onboarding.css">
</head>
<body>
    <div class="container">
        <!-- ========================================
             HEADER
        ======================================== -->
        <header class="header">
            <div class="logo">
                <img src="icons/48.png" alt="WhatsHybrid logo" class="logo-icon-img">
                <h1 id="spHeaderTitle">WhatsHybrid</h1>
            </div>
            <div class="header-actions">
                <button id="btnViewHistory" class="btn-icon-header" title="Ver HistÃ³rico (Ctrl+H)">
                    ğŸ“œ
                </button>
                <span class="version">v6.0.7</span>
            </div>
        </header>

        <!-- ========================================
             WHL FUSION: VIEW ROOT (dynamic content)
        ======================================== -->
        <div id="whlViewRoot" class="whl-view-root">

            <!-- ============ VIEW: PRINCIPAL ============ -->
            <section id="whlViewPrincipal" class="whl-view">
  <div class="sp-card">
    <div class="sp-title">ğŸ“¨ Disparo de mensagens â€” Envio em massa</div>
    <div class="sp-muted">Cole os nÃºmeros, escreva a mensagem, anexe uma imagem (opcional), gere a tabela e inicie a campanha.</div>

    <label class="sp-label">ğŸ“± NÃºmeros (um por linha)</label>
    <textarea id="sp_numbers" class="sp-textarea" placeholder="5511999998888&#10;5511988887777"></textarea>

    <div class="sp-row" style="margin-top:8px;align-items:center">
      <input id="sp_csv" type="file" accept=".csv,text/csv" style="display:none" />
      <button id="sp_select_csv" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“Š Importar CSV</button>
      <button id="sp_clear_csv" class="sp-btn sp-btn-danger" style="display:none">ğŸ—‘ï¸ Remover</button>
    </div>
    
    <div class="sp-row" style="margin-top:8px;align-items:center">
      <input id="sp_excel_file" type="file" accept=".xlsx,.xls" style="display:none" />
      <button id="sp_import_excel" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“Š Importar Excel</button>
    </div>
    
    <div id="sp_csv_hint" class="sp-status"></div>

    <label class="sp-label" style="margin-top:10px">ğŸ’¬ Mensagem</label>
    
    <div style="position:relative">
      <textarea id="sp_message" class="sp-textarea" style="min-height:120px;padding-right:56px" placeholder="Digite a mensagem..."></textarea>
      <button id="sp_emoji_btn" class="sp-btn sp-btn-secondary" style="position:absolute;right:8px;bottom:8px;padding:6px 10px">ğŸ˜Š</button>
      <div id="sp_emoji_picker" style="display:none;position:absolute;right:8px;bottom:50px;z-index:10;background:rgba(0,0,0,0.60);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:8px;max-width:260px"></div>
    </div>

    <div class="sp-row" style="margin-top:8px;align-items:center">
      <input id="sp_image" type="file" accept="image/*" style="display:none" />
      <button id="sp_select_image" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“ Anexar imagem</button>
      <button id="sp_clear_image" class="sp-btn sp-btn-danger" style="display:none">ğŸ—‘ï¸ Remover</button>
    </div>
    <div id="sp_image_hint" class="sp-status"></div>

    <div class="sp-row" style="margin-top:8px">
      <button id="sp_save_message" class="sp-btn sp-btn-secondary">ğŸ’¾ Salvar Mensagem</button>
    </div>

    <div class="sp-title" style="font-size:13px;margin-top:10px">ğŸ“± Preview</div>
    <div class="wa-chat">
      <div class="wa-bubble">
        <img id="sp_preview_img" src="" style="display:none;max-width:100%;border-radius:10px;margin-bottom:8px" />
        <div id="sp_preview_text" style="white-space:pre-wrap;word-break:break-word"></div>
        <div class="wa-time">
          <span id="sp_preview_meta"></span>
          <span class="wa-ticks">âœ“âœ“</span>
        </div>
      </div>
    </div>

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_build_queue" class="sp-btn sp-btn-primary" style="flex:1">ğŸ“‹ Gerar tabela</button>
      <button id="sp_clear_fields" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ§¹ Limpar</button>
    </div>

    <div id="sp_hint" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸš€ Campanha</div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1;min-width:90px;background:rgba(0,0,0,0.10);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:8px">
        <div class="sp-muted" style="font-size:10px">âœ… Enviadas</div>
        <div id="sp_stat_sent" style="font-size:16px;font-weight:900">0</div>
      </div>
      <div style="flex:1;min-width:90px;background:rgba(0,0,0,0.10);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:8px">
        <div class="sp-muted" style="font-size:10px">âŒ Falhas</div>
        <div id="sp_stat_failed" style="font-size:16px;font-weight:900">0</div>
      </div>
      <div style="flex:1;min-width:90px;background:rgba(0,0,0,0.10);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:8px">
        <div class="sp-muted" style="font-size:10px">â³ Pendentes</div>
        <div id="sp_stat_pending" style="font-size:16px;font-weight:900">0</div>
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="sp-muted" id="sp_progress_text">0%</div>
      <div style="height:10px;background:rgba(255,255,255,0.10);border-radius:999px;overflow:hidden">
        <div id="sp_progress_fill" style="height:100%;width:0%;background:rgba(37,211,102,0.85)"></div>
      </div>
      <div class="sp-muted" id="sp_estimated_time" style="margin-top:6px"></div>
    </div>

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_start" class="sp-btn sp-btn-primary" style="flex:1">â–¶ï¸ Iniciar</button>
      <button id="sp_pause" class="sp-btn sp-btn-secondary" style="flex:1">â¸ï¸ Pausar</button>
      <button id="sp_stop" class="sp-btn sp-btn-danger" style="flex:1">â¹ï¸ Parar</button>
    </div>

    <div id="sp_campaign_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“‹ Tabela / Fila</div>
    <div class="sp-muted" id="sp_queue_meta">0 contatos</div>

    <div class="sp-queue-container" style="margin-top:8px">
      <table>
        <thead>
          <tr>
            <th style="width:44px">#</th>
            <th>NÃºmero</th>
            <th style="width:92px">Status</th>
            <th style="width:70px">AÃ§Ã£o</th>
          </tr>
        </thead>
        <tbody id="sp_queue_table"></tbody>
      </table>
    </div>

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_skip" class="sp-btn sp-btn-secondary" style="flex:1">â­ï¸ Pular atual</button>
      <button id="sp_wipe" class="sp-btn sp-btn-danger" style="flex:1">ğŸ§¨ Zerar fila</button>
    </div>
  </div>
</section>

            <!-- ============ VIEW: EXTRATOR ============ -->
            <section id="whlViewExtrator" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ“¥ Extrator de contatos</div>
    <div class="sp-muted">Extrai contatos Normais, Arquivados e Bloqueados do WhatsApp Web.</div>

    <div class="sp-row">
      <button id="sp_extract_contacts" class="sp-btn sp-btn-primary">ğŸ“¥ Extrair</button>
      <button id="sp_refresh_extract" class="sp-btn sp-btn-secondary">ğŸ”„ Atualizar</button>
      <button id="sp_copy_extract_all" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Todos</button>
    </div>

    <div id="sp_extract_status" class="sp-status">Pronto.</div>

    <div style="margin-top:10px">
      <div class="sp-title" style="font-size:13px">âœ… Normais (<span id="sp_count_normal">0</span>)</div>
      <textarea id="sp_normal_list" class="sp-textarea"></textarea>
      <div class="sp-row" style="margin-top:6px">
        <button id="sp_copy_normal" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Normais</button>
      </div>

      <div class="sp-title" style="font-size:13px;margin-top:12px">ğŸ“ Arquivados (<span id="sp_count_archived">0</span>)</div>
      <textarea id="sp_archived_list" class="sp-textarea"></textarea>
      <div class="sp-row" style="margin-top:6px">
        <button id="sp_copy_archived" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Arquivados</button>
      </div>

      <div class="sp-title" style="font-size:13px;margin-top:12px">â›” Bloqueados (<span id="sp_count_blocked">0</span>)</div>
      <textarea id="sp_blocked_list" class="sp-textarea"></textarea>
      <div class="sp-row" style="margin-top:6px">
        <button id="sp_copy_blocked" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Bloqueados</button>
      </div>
    </div>
  </div>
</section>

            <!-- ============ VIEW: GRUPOS (V6 - EXISTENTE) ============ -->
            <section id="whlViewGroups" class="whl-view hidden">


        <!-- ========================================
             BARRA DE STATUS
        ======================================== -->
        <div id="statusBar" class="status-bar hidden">
            <span id="statusText">Aguardando...</span>
            <div id="progressBar" class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
                <span class="progress-text" id="progressPercent">0%</span>
            </div>
            <!-- Controles de extraÃ§Ã£o -->
            <div id="extractionControls" class="extraction-controls hidden">
                <button id="btnPauseExtraction" class="btn-control btn-control-pause" title="Pausar extraÃ§Ã£o">
                    â¸ï¸ Pausar
                </button>
                <button id="btnResumeExtraction" class="btn-control btn-control-resume hidden" title="Continuar extraÃ§Ã£o">
                    â–¶ï¸ Continuar
                </button>
                <button id="btnStopExtraction" class="btn-control btn-control-stop" title="Parar extraÃ§Ã£o">
                    â¹ï¸ Parar
                </button>
            </div>
        </div>

        <!-- ========================================
             ETAPA 1: CARREGAR GRUPOS
        ======================================== -->
        <section id="step1" class="step">
            <!-- Dica de reconexÃ£o SEMPRE VISÃVEL -->
            <div class="tip-bubble tip-info" id="connectionTip">
                <div class="tip-content">
                    ğŸ’¡ Se "Carregar Grupos" nÃ£o funcionar, <strong>clique no Ã­cone da extensÃ£o</strong> (ğŸ§©) para reconectar.
                </div>
            </div>

            <!-- NOVO: Dica de reconexÃ£o (oculta por padrÃ£o) -->
            <div class="tip-bubble tip-warning" id="reconnectTip" style="display: none;">
                <div class="tip-content">
                    âš ï¸ ConexÃ£o perdida. <strong>Clique no Ã­cone da extensÃ£o</strong> (ğŸ§©) para reconectar.
                </div>
            </div>

            <button id="btnLoadGroups" class="btn btn-primary btn-large">
                <span class="btn-icon">ğŸ“‚</span>
                Carregar Grupos
            </button>
            
            <button id="btnForceRefresh" class="btn btn-secondary" style="margin-top:8px;display:none">
                <span class="btn-icon">ğŸ”„</span>
                ForÃ§ar AtualizaÃ§Ã£o
            </button>

            <!-- Atalhos -->
            <div class="shortcuts-box">
                <p class="shortcuts-title">âŒ¨ï¸ Atalhos:</p>
                <ul class="shortcuts-list">
                    <li><kbd>Ctrl+L</kbd> Carregar grupos</li>
                    <li><kbd>Ctrl+H</kbd> Ver histÃ³rico</li>
                    <li><kbd>Ctrl+F</kbd> Buscar grupo</li>
                </ul>
            </div>
        </section>

        <!-- ========================================
             ETAPA 2: SELECIONAR GRUPO
        ======================================== -->
        <section id="step2" class="step hidden">
            <div class="groups-header">
                <h2>Selecione um Grupo</h2>
                <span id="groupCount" class="badge">0 grupos</span>
            </div>

            <!-- EstatÃ­sticas -->
            <div id="groupStats" class="group-stats">
                <div class="stat-item" id="statTotal">
                    <span class="stat-icon">ğŸ“Š</span>
                    <div class="stat-info">
                        <span class="stat-label">Total:</span>
                        <span class="stat-value">0</span>
                        <span class="stat-unit">grupos</span>
                    </div>
                </div>
                
                <!-- SEPARADOR 1 - Entre Total e Ativos -->
                <div class="stats-separator"></div>
                
                <div class="stat-item" id="statActive">
                    <span class="stat-icon">âœ…</span>
                    <div class="stat-info">
                        <span class="stat-label">Ativos:</span>
                        <span class="stat-value">0</span>
                    </div>
                </div>
                
                <!-- SEPARADOR 2 - Entre Ativos e Arquivados -->
                <div class="stats-separator"></div>
                
                <div class="stat-item" id="statArchived">
                    <span class="stat-icon">ğŸ“¦</span>
                    <div class="stat-info">
                        <span class="stat-label">Arquivados:</span>
                        <span class="stat-value">0</span>
                    </div>
                </div>
            </div>

            <!-- Filtros por abas -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">
                    <span class="tab-icon">ğŸ“‹</span> Todos
                </button>
                <button class="filter-tab" data-filter="active">
                    <span class="tab-icon">ğŸ’¬</span> Ativos
                </button>
                <button class="filter-tab" data-filter="archived">
                    <span class="tab-icon">ğŸ“¦</span> Arquivados
                </button>
            </div>

            <!-- Campo de busca -->
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input 
                    type="text" 
                    id="searchGroups" 
                    placeholder="Filtrar grupos..." 
                    autocomplete="off" 
                />
            </div>

            <!-- Lista de grupos (Virtual Scroll) -->
            <div id="groupsList" class="groups-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Carregando grupos...</p>
                </div>
            </div>

            <!-- AÃ§Ãµes -->
            <div class="actions">
                <button id="btnBack" class="btn btn-secondary">
                    â† Voltar
                </button>
                <button id="btnExtract" class="btn btn-primary" disabled>
                    <span class="btn-icon">ğŸ“¥</span>
                    Extrair Membros
                </button>
            </div>
        </section>

        <!-- ========================================
             ETAPA 3: RESULTADO
        ======================================== -->
        <section id="step3" class="step hidden">
            <div class="result-header">
                <span class="result-icon">âœ…</span>
                <h2>ExtraÃ§Ã£o ConcluÃ­da!</h2>
            </div>

            <!-- InformaÃ§Ãµes do resultado -->
            <div class="result-info">
                <div class="result-item">
                    <span class="label">Grupo:</span>
                    <span id="resultGroupName" class="value">-</span>
                </div>
                <div class="result-item">
                    <span class="label">Status:</span>
                    <span id="resultGroupStatus" class="value">-</span>
                </div>
                <div class="result-item">
                    <span class="label">Membros:</span>
                    <span id="resultMemberCount" class="value">-</span>
                </div>
            </div>

            <!-- Lista de membros extraÃ­dos (Virtual Scroll) -->
            <div class="members-container">
                <h3 class="members-title">
                    <span class="members-icon">ğŸ‘¥</span>
                    Membros ExtraÃ­dos
                </h3>
                <div id="membersList" class="members-list">
                    <!-- Membros serÃ£o inseridos aqui via Virtual Scroll -->
                </div>
            </div>

            <!-- BotÃµes de exportaÃ§Ã£o -->
            <div class="export-buttons">
                <button id="btnExportCSV" class="btn btn-export" title="Exportar como CSV (Ctrl+S)">
                    ğŸ“„ CSV
                </button>
                <button id="btnCopyList" class="btn btn-export" title="Copiar lista">
                    ğŸ“‹ Copiar
                </button>
            </div>

            <!-- BotÃµes Google Sheets -->
            <div class="sheets-buttons">
                <button id="btnCopySheets" class="btn btn-sheets" title="Copiar para Google Sheets (Ctrl+G)">
                    <span class="btn-icon">ğŸ“Š</span> Copiar para Sheets
                </button>
                <button id="btnOpenSheets" class="btn btn-sheets-outline" title="Abrir no Google Sheets">
                    <span class="btn-icon">ğŸ”—</span> Abrir no Sheets
                </button>
            </div>

            <!-- BotÃ£o nova extraÃ§Ã£o -->
            <button id="btnNewExtraction" class="btn btn-secondary btn-large">
                ğŸ”„ Nova ExtraÃ§Ã£o
            </button>
        </section>

        <!-- ========================================
             ETAPA 4: HISTÃ“RICO
        ======================================== -->
        <section id="step4" class="step hidden">
            <div class="history-header">
                <h2>ğŸ“œ HistÃ³rico de ExtraÃ§Ãµes</h2>
            </div>

            <!-- EstatÃ­sticas do histÃ³rico -->
            <div id="historyStats" class="history-stats">
                <!-- Stats serÃ£o inseridas dinamicamente -->
            </div>

            <!-- Lista do histÃ³rico -->
            <div id="historyList" class="history-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Carregando histÃ³rico...</p>
                </div>
            </div>

            <!-- AÃ§Ãµes do histÃ³rico -->
            <div class="actions">
                <button id="btnBackFromHistory" class="btn btn-secondary">
                    â† Voltar
                </button>
                <button id="btnClearHistory" class="btn btn-danger">
                    ğŸ—‘ï¸ Limpar Tudo
                </button>
            </div>
        </section>

        <!-- ========================================
             MENSAGEM DE ERRO
        ======================================== -->
        <div id="errorBox" class="error-box hidden">
            <span class="error-icon">âš ï¸</span>
            <span id="errorText" class="error-text">Erro desconhecido</span>
            <button id="btnDismissError" class="btn-dismiss" title="Fechar">
                âœ•
            </button>
        </div>

            </section>

            <!-- ============ VIEW: RECOVER ============ -->
            <section id="whlViewRecover" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ”„ Recover</div>
    <div class="sp-muted">Mostra mensagens apagadas/editadas capturadas em tempo real (salvas no histÃ³rico local do WhatsApp Web).</div>

    <div class="sp-row">
      <button id="sp_refresh_recover" class="sp-btn sp-btn-secondary">ğŸ”„ Atualizar</button>
      <button id="sp_download_all_recover" class="sp-btn sp-btn-primary">â¬‡ï¸ Baixar Todos</button>
      <button id="sp_clear_recover" class="sp-btn sp-btn-danger">ğŸ—‘ï¸ Limpar</button>
    </div>

    <div class="sp-row" style="margin-top:8px;align-items:center;justify-content:space-between">
      <div class="sp-muted">Total: <b id="sp_recover_total">0</b></div>
      <div class="sp-muted">Mostrando atÃ© 200</div>
    </div>

    <div id="sp_recover_status" class="sp-status">Pronto.</div>

    <div id="sp_recover_timeline" class="timeline-container"></div>
  </div>
</section>

            <!-- ============ VIEW: CONFIG ============ -->
            <section id="whlViewConfig" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">âš™ï¸ ConfiguraÃ§Ãµes</div>
    <div class="sp-muted">Ajuste delays, agendamento, templates e relatÃ³rio (igual ao mÃ³dulo original).</div>

    <label class="sp-label">â±ï¸ Delay mÃ­nimo (segundos)</label>
    <input id="sp_delay_min" type="number" class="sp-input" min="0" step="0.5" placeholder="Ex: 2" />

    <label class="sp-label" style="margin-top:10px">â±ï¸ Delay mÃ¡ximo (segundos)</label>
    <input id="sp_delay_max" type="number" class="sp-input" min="0" step="0.5" placeholder="Ex: 6" />

    <label class="sp-label" style="margin-top:10px">â° Agendar envio (AAAA-MM-DD HH:MM) â€” opcional</label>
    <input id="sp_schedule" type="datetime-local" class="sp-input" />

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_save_settings" class="sp-btn sp-btn-primary" style="flex:1">ğŸ’¾ Salvar</button>
      <button id="sp_reload_settings" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ”„ Recarregar</button>
    </div>

    <div id="sp_config_status" class="sp-status">Pronto.</div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“… Agendamentos</div>
    <div class="sp-muted">Agende mÃºltiplas campanhas para horÃ¡rios diferentes.</div>
    
    <div class="sp-row" style="margin-top:10px">
      <input id="sp_schedule_name" class="sp-input" placeholder="Nome da campanha" style="flex:2">
      <input id="sp_schedule_time" type="datetime-local" class="sp-input" style="flex:2">
      <button id="sp_add_schedule" class="sp-btn sp-btn-primary" style="white-space:nowrap">â• Agendar</button>
    </div>
    
    <div id="sp_schedules_list" class="sp-queue-container" style="margin-top:8px;max-height:250px"></div>
    <div id="sp_schedule_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ›¡ï¸ Anti-Ban Inteligente</div>
    <div class="sp-muted">ProteÃ§Ã£o contra bloqueios com delays inteligentes e limite diÃ¡rio.</div>
    
    <label class="sp-label">Limite diÃ¡rio de mensagens</label>
    <input id="sp_daily_limit" type="number" class="sp-input" value="200" min="1" max="1000">
    
    <div class="sp-row" style="margin-top:8px">
      <span class="sp-muted">Enviadas hoje: <b id="sp_sent_today">0</b> / <b id="sp_daily_limit_display">200</b></span>
    </div>
    
    <div id="sp_daily_progress" style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin-top:8px">
      <div id="sp_daily_progress_fill" style="height:100%;width:0%;background:#25D366;border-radius:4px;transition:width 0.3s"></div>
    </div>
    
    <label class="sp-checkbox" style="margin-top:10px">
      <input type="checkbox" id="sp_business_hours_only">
      <span>Enviar apenas em horÃ¡rio comercial (8h-20h)</span>
    </label>
    
    <div class="sp-row" style="margin-top:10px">
      <button id="sp_save_antiban" class="sp-btn sp-btn-primary">ğŸ’¾ Salvar</button>
      <button id="sp_reset_daily_count" class="sp-btn sp-btn-secondary">ğŸ”„ Resetar contador</button>
    </div>
    
    <div id="sp_antiban_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ”” NotificaÃ§Ãµes</div>
    <div class="sp-muted">Alertas desktop para eventos importantes.</div>
    
    <label class="sp-checkbox">
      <input type="checkbox" id="sp_enable_notifications" checked>
      <span>Ativar notificaÃ§Ãµes desktop</span>
    </label>
    
    <label class="sp-checkbox">
      <input type="checkbox" id="sp_enable_sounds" checked>
      <span>Ativar sons</span>
    </label>
    
    <button id="sp_test_notification" class="sp-btn sp-btn-secondary" style="margin-top:8px">ğŸ”” Testar NotificaÃ§Ã£o</button>
    <div id="sp_notification_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“ Templates</div>
    <div class="sp-muted">Salva e restaura fila, mensagem, imagem e contatos extraÃ­dos. Suporte a variÃ¡veis dinÃ¢micas.</div>

    <div class="sp-row" style="align-items:center">
      <input id="sp_draft_name" type="text" class="sp-input" placeholder="Nome do template" />
      <button id="sp_save_draft" class="sp-btn sp-btn-primary" style="white-space:nowrap">Salvar</button>
    </div>
    
    <div class="sp-muted" style="margin-top:8px;font-size:11px">
      ğŸ“Œ VariÃ¡veis disponÃ­veis: {nome}, {empresa}, {data}, {hora}, {numero}, {saudacao}
    </div>

    <div class="sp-queue-container" style="margin-top:8px;max-height:36vh">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th style="width:92px">Data</th>
            <th style="width:52px">#</th>
            <th style="width:92px">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="sp_drafts_body"></tbody>
      </table>
    </div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“„ RelatÃ³rio</div>
    <div class="sp-muted">Exportar CSV da fila e copiar falhas.</div>

    <div class="sp-row">
      <button id="sp_export_report" class="sp-btn sp-btn-secondary" style="flex:1">â¬‡ï¸ Exportar CSV</button>
      <button id="sp_copy_failed" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“‹ Copiar falhas</button>
    </div>

    <div id="sp_report_hint" class="sp-status"></div>
  </div>
</section>

            <!-- ============ VIEW: BACKUP ============ -->
            <section id="whlViewBackup" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ’¾ Backup de Conversas</div>
    <div class="sp-muted">Exporte conversas do WhatsApp em mÃºltiplos formatos (HTML, CSV, JSON, TXT) com suporte a mÃ­dias.</div>
    
    <!-- Seletor de Contatos -->
    <div class="backup-section">
      <label class="sp-label">ğŸ“± Selecionar Conversa</label>
      <div class="sp-row" style="margin-top:8px">
        <button id="backup_load_contacts" class="sp-btn sp-btn-primary" style="flex:1">ğŸ“‚ Carregar Chats</button>
        <button id="backup_refresh_contacts" class="sp-btn sp-btn-secondary" style="display:none">ğŸ”„ Atualizar</button>
      </div>
      
      <!-- Campo de busca -->
      <div style="position:relative;margin-top:8px;display:none" id="backup_search_container">
        <input id="backup_search" type="text" class="sp-input" placeholder="ğŸ” Buscar chat..." />
      </div>
      
      <!-- Lista de contatos -->
      <div id="backup_contacts_list" class="backup-contacts-list" style="display:none"></div>
      
      <!-- Card do chat selecionado -->
      <div id="backup_selected_chat" class="backup-selected-chat" style="display:none">
        <div class="backup-chat-icon" id="backup_chat_icon">ğŸ‘¤</div>
        <div class="backup-chat-info">
          <div class="backup-chat-name" id="backup_chat_name">-</div>
          <div class="backup-chat-type" id="backup_chat_type">-</div>
        </div>
      </div>
    </div>
    
    <!-- OpÃ§Ãµes de ExportaÃ§Ã£o -->
    <div class="backup-section" id="backup_options_section" style="display:none">
      <label class="sp-label">âš™ï¸ OpÃ§Ãµes de ExportaÃ§Ã£o</label>
      
      <!-- Formato -->
      <div style="margin-top:8px">
        <label class="sp-muted" style="font-size:11px">Formato:</label>
        <select id="backup_format" class="sp-input">
          <option value="html">ğŸ“„ HTML (Visual)</option>
          <option value="csv">ğŸ“Š CSV (Planilha)</option>
          <option value="json">ğŸ“‹ JSON (Dados)</option>
          <option value="txt">ğŸ“ TXT (Texto)</option>
        </select>
      </div>
      
      <!-- Limite de mensagens -->
      <div style="margin-top:8px">
        <label class="sp-muted" style="font-size:11px">Limite de mensagens:</label>
        <select id="backup_limit" class="sp-input">
          <option value="1000">1.000 mensagens</option>
          <option value="5000">5.000 mensagens</option>
          <option value="10000" selected>10.000 mensagens</option>
          <option value="50000">50.000 mensagens</option>
          <option value="100000">100.000 mensagens</option>
          <option value="all">Todas as mensagens</option>
        </select>
      </div>
      
      <!-- PerÃ­odo -->
      <div style="margin-top:8px">
        <label class="sp-muted" style="font-size:11px">PerÃ­odo (opcional):</label>
        <div class="sp-row" style="gap:8px">
          <input id="backup_date_from" type="date" class="sp-input" placeholder="De" style="flex:1" />
          <input id="backup_date_to" type="date" class="sp-input" placeholder="AtÃ©" style="flex:1" />
        </div>
      </div>
      
      <!-- Checkboxes -->
      <div style="margin-top:8px">
        <label class="sp-checkbox">
          <input type="checkbox" id="backup_include_date" checked>
          <span>Incluir data/hora</span>
        </label>
        <label class="sp-checkbox">
          <input type="checkbox" id="backup_include_sender" checked>
          <span>Incluir remetente</span>
        </label>
      </div>
      
      <!-- Exportar MÃ­dias -->
      <div style="margin-top:12px">
        <label class="sp-muted" style="font-size:11px">ğŸ“ Exportar MÃ­dias (opcional):</label>
        <label class="sp-checkbox">
          <input type="checkbox" id="backup_export_images">
          <span>ğŸ–¼ï¸ Imagens</span>
        </label>
        <label class="sp-checkbox">
          <input type="checkbox" id="backup_export_audios">
          <span>ğŸµ Ãudios</span>
        </label>
        <label class="sp-checkbox">
          <input type="checkbox" id="backup_export_docs">
          <span>ğŸ“„ Documentos</span>
        </label>
      </div>
    </div>
    
    <!-- BotÃµes de aÃ§Ã£o -->
    <div class="sp-row" style="margin-top:12px" id="backup_action_buttons" style="display:none">
      <button id="backup_start" class="sp-btn sp-btn-primary" style="flex:1">â–¶ï¸ Exportar Conversa</button>
      <button id="backup_cancel" class="sp-btn sp-btn-danger" style="flex:1;display:none">â¹ï¸ Cancelar</button>
    </div>
    
    <!-- Status e Progresso -->
    <div id="backup_status" class="sp-status" style="margin-top:8px"></div>
    
    <!-- Barra de progresso principal -->
    <div id="backup_progress_container" style="display:none;margin-top:10px">
      <div class="sp-muted" id="backup_progress_text">0%</div>
      <div style="height:10px;background:rgba(255,255,255,0.10);border-radius:999px;overflow:hidden">
        <div id="backup_progress_fill" style="height:100%;width:0%;background:rgba(37,211,102,0.85);transition:width 0.3s"></div>
      </div>
      <div class="sp-muted" id="backup_progress_status" style="margin-top:6px;font-size:11px">Iniciando...</div>
    </div>
    
    <!-- Progresso de MÃ­dias -->
    <div id="backup_media_progress_container" class="backup-media-progress-container" style="display:none;margin-top:12px">
      <div class="sp-muted" style="font-size:11px;margin-bottom:6px">ğŸ“ Download de MÃ­dias:</div>
      
      <!-- Imagens -->
      <div class="backup-media-progress-item">
        <div class="backup-media-progress-label">
          <span>ğŸ–¼ï¸ Imagens</span>
          <span id="backup_images_count">0/0</span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,0.10);border-radius:999px;overflow:hidden">
          <div id="backup_images_progress" style="height:100%;width:0%;background:rgba(37,211,102,0.85);transition:width 0.3s"></div>
        </div>
      </div>
      
      <!-- Ãudios -->
      <div class="backup-media-progress-item">
        <div class="backup-media-progress-label">
          <span>ğŸµ Ãudios</span>
          <span id="backup_audios_count">0/0</span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,0.10);border-radius:999px;overflow:hidden">
          <div id="backup_audios_progress" style="height:100%;width:0%;background:rgba(37,211,102,0.85);transition:width 0.3s"></div>
        </div>
      </div>
      
      <!-- Documentos -->
      <div class="backup-media-progress-item">
        <div class="backup-media-progress-label">
          <span>ğŸ“„ Documentos</span>
          <span id="backup_docs_count">0/0</span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,0.10);border-radius:999px;overflow:hidden">
          <div id="backup_docs_progress" style="height:100%;width:0%;background:rgba(37,211,102,0.85);transition:width 0.3s"></div>
        </div>
      </div>
    </div>
  </div>
</section>

        </div>



        <!-- ========================================
             FOOTER
        ======================================== -->
        <footer class="footer">
            <span class="footer-text">
                WhatsApp Group Member Extractor
            </span>
        </footer>
    </div>

    <!-- ========================================
         SCRIPTS - SEM type="module"
    ======================================== -->
    <!-- SheetJS for Excel import - Using CDN with integrity check -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" 
            integrity="sha384-PwMb8JZs4L3f8BcbjQzYR7gq/r/rqcCd2rQ6/qzBkGlwNjJYyZDxLmN6qVeV4KbC"
            crossorigin="anonymous"></script>
    
    <!-- JSZip for media export - v3.10.1 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" 
            integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg=="
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    
    <!-- Utilities -->
    <script src="utils/utils-optimized.js"></script>
    <script src="utils/storage.js"></script>
    <script src="utils/google-sheets-export.js"></script>
    <script src="utils/templates.js"></script>
    
    <!-- New advanced utilities -->
    <script src="utils/scheduler.js"></script>
    <script src="utils/anti-ban.js"></script>
    <script src="utils/contact-importer.js"></script>
    <script src="utils/group-cache.js"></script>
    <script src="utils/notifications.js"></script>
    <script src="utils/media-handler.js"></script>
    
    <!-- Core scripts -->
    <script src="onboarding.js"></script>
    <script src="sidepanel.js"></script>
    <script src="sidepanel-router.js"></script>
    
    <!-- Initialize Onboarding -->
    <script>
        // Initialize onboarding system after page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof OnboardingSystem !== 'undefined') {
                    const onboarding = new OnboardingSystem();
                    if (onboarding.shouldShow()) {
                        onboarding.start();
                    }
                    
                    // Make it available globally for testing
                    window.whlOnboarding = onboarding;
                }
            }, 500); // Small delay to ensure everything is loaded
        });
    </script>
</body>
</html>
